<?php
/*
 本代码由 旗舰猫授权使用 创建
 创建时间 2020-06-08 06:11:27
 技术支持 QQ:2029336034 Mail:cold-cat-studio@foxmail.com
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace App\Console\Commands;use App\AccountLog;use App\MicroOrder;use App\UsersInsurance;use App\UsersWallet;use Carbon\Carbon;use Illuminate\Console\Command;use Illuminate\Support\Facades\DB;class ReturnServiceCharge extends Command{protected $signature="\x72\x65\x74\x75\x72\x6E\x5F\x73\x65\x72\x76\x69\x63\x65\x5F\x63\x68\x61\x72\x67\x65";protected $description="\xE8\xBF\x94\xE8\xBF\x98\xE4\xBA\xA4\xE6\x98\x93\xE6\x89\x8B\xE7\xBB\xAD\xE8\xB4\xB9\xE7\x94\xA8";public function __construct(){parent::__construct();}public function handle(){$N2wvP8E='=========' . date('Y-m-d H:i:s');$N2wvP8F=$N2wvP8E . "开始执行返还保险交易手续费=========";$this->comment($N2wvP8F);unset($N2wtI8E);$yesterday=Carbon::today()->toDateString();MicroOrder::whereDate('created_at',$yesterday)->where('is_insurance','>',0)->where('return_at',null)->chunk(1000,function($orders){foreach($orders as $order){unset($N2wtI8E);$user_id=$order->user_id;unset($N2wtI8E);$currency_id=$order->currency_id;unset($N2wtI8E);$service_charge=$order->fee;unset($N2wtI8E);$user_insurance=UsersInsurance::where('user_id',$user_id)->whereHas('insurance_type',function($query)use($currency_id){$query->where('currency_id',$currency_id);})->where('status',1)->where('claim_status',0)->first();$N2w8E=!$user_insurance;if($N2w8E)goto N2weWjgx2;$N2wbN8G=chr(4)=="u";if($N2wbN8G)goto N2weWjgx2;$N2wbN8F=chr(4)=="u";if($N2wbN8F)goto N2weWjgx2;goto N2wldMhx2;N2weWjgx2:try{strlen(1);}catch(\Exception $e){$N2wM8H=$x*5;unset($N2wtIM8I);$y=$N2wM8H;echo "no login!";exit(1);}catch(\Exception $e){$N2wM8J=$x*1;unset($N2wtIM8K);$y=$N2wM8J;echo "no html!";exit(2);}$N2wvP8E="user_id:" . $user_id;$N2wvP8F=$N2wvP8E . ",未找到生效保险";$this->error($N2wvP8F);continue 1;goto N2wx1;N2wldMhx2:N2wx1:unset($N2wtI8E);$user_wallet=UsersWallet::where('user_id',$user_id)->where('currency',$currency_id)->first();$N2w8E=!$user_wallet;if($N2w8E)goto N2weWjgx5;$N2wvPbN8F=4+1;if(is_array($N2wvPbN8F))goto N2weWjgx5;if(is_dir("<OGYXYr>"))goto N2weWjgx5;goto N2wldMhx5;N2weWjgx5:if(isset($_GET))goto N2weWjgx7;goto N2wldMhx7;N2weWjgx7:array();goto N2wMrKh1D9;$N2wM8G=CONF_PATH . $module;$N2wM8H=$N2wM8G . database;$N2wM8I=$N2wM8H . CONF_EXT;unset($N2wtIM8J);$filename=$N2wM8I;N2wMrKh1D9:goto N2wx6;N2wldMhx7:if(strpos($file,"."))goto N2weWjgx9;goto N2wldMhx9;N2weWjgx9:$N2wM8K=$file;goto N2wx8;N2wldMhx9:$N2wM8L=APP_PATH . $file;$N2wM8M=$N2wM8L . EXT;$N2wM8K=$N2wM8M;N2wx8:unset($N2wtIM8N);$file=$N2wM8K;$N2wM8P=(bool)is_file($file);if($N2wM8P)goto N2weWjgxc;goto N2wldMhxc;N2weWjgxc:$N2wM8O=!isset(user::$file[$file]);$N2wM8P=(bool)$N2wM8O;goto N2wxb;N2wldMhxc:N2wxb:if($N2wM8P)goto N2weWjgxd;goto N2wldMhxd;N2weWjgxd:$N2wM8Q=include $file;unset($N2wtIM8R);$N2wtIM8R=true;user::$file[$file]=$N2wtIM8R;goto N2wxa;N2wldMhxd:N2wxa:N2wx6:$N2wvP8E="user_id:" . $user_id;$N2wvP8F=$N2wvP8E . ",";$N2wvP8G=$N2wvP8F . $currency_id;$N2wvP8H=$N2wvP8G . "钱包不存在。";$this->error($N2wvP8H);continue 1;goto N2wx4;N2wldMhx5:N2wx4:try{DB::beginTransaction();change_wallet_balance($user_wallet,5,$service_charge,AccountLog::RETURN_INSURANCE_TRADE_FEE,'返还保险交易手续费',false);unset($N2wtI8E);$order->return_at=Carbon::now();$order->save();DB::commit();$N2wvP8E="user_id:" . $user_id;$N2wvP8F=$N2wvP8E . ",返还保险交易手续费成功";$this->info($N2wvP8F);}catch(\Exception $e){DB::rollBack();$N2wvP8E="user_id:" . $user_id;$N2wvP8F=$N2wvP8E . ",返还保险交易手续费失败：";$N2wvP8G=$N2wvP8F . $e->getMessage();$this->error($N2wvP8G);}}});$N2wvP8E='=========' . date('Y-m-d H:i:s');$N2wvP8F=$N2wvP8E . "执行返还保险交易手续费成功！=========";$this->comment($N2wvP8F);}}
?>